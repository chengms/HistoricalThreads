# 自定义域名快速修复指南

## 问题现象

访问自定义域名 `history.tangping.space` 时，页面显示空白，控制台显示 404 错误：

```
GET http://history.tangping.space/HistoricalThreads/assets/index-XXX.js 404
GET http://history.tangping.space/HistoricalThreads/assets/index-XXX.css 404
```

## 问题原因

资源文件路径在**构建时**就已经确定，无法在运行时修改。如果构建时没有设置 `VITE_USE_CUSTOM_DOMAIN=true`，资源路径会被硬编码为 `/HistoricalThreads/assets/...`，导致在自定义域名下无法加载。

## 解决方案（必须操作）

### 步骤 1: 在 GitHub 仓库中设置环境变量

⚠️ **重要**：必须在**仓库级别**设置，不是在 Environment 级别！

1. **访问仓库设置页面**：
   ```
   https://github.com/chengms/HistoricalThreads/settings
   ```
   或者直接访问：
   ```
   https://github.com/chengms/HistoricalThreads/settings/secrets/actions
   ```

2. **进入 Variables 设置**：
   - 在左侧菜单中找到 **Secrets and variables**（在 Settings 页面）
   - 点击展开，选择 **Actions**
   - 点击 **Variables** 标签页（不是 Secrets 标签页）
   - ⚠️ 注意：如果你看到的是 "Environment variables"，说明你在错误的位置，需要返回到仓库设置主页

3. **添加新变量**：
   - 点击 **New repository variable** 按钮
   - **Name**: `VITE_USE_CUSTOM_DOMAIN`
   - **Value**: `true`
   - 点击 **Add variable**

**完整路径**：`Settings > Secrets and variables > Actions > Variables`

### 步骤 2: 重新触发部署

有两种方式：

**方式 A: 推送一个空提交（推荐）**
```bash
git commit --allow-empty -m "Trigger rebuild for custom domain"
git push origin main
```

**方式 B: 手动触发 workflow**
1. 访问：`https://github.com/chengms/HistoricalThreads/actions`
2. 选择最新的 "Deploy to GitHub Pages" workflow
3. 点击 **Run workflow** 按钮
4. 选择 `main` 分支
5. 点击 **Run workflow**

### 步骤 3: 等待部署完成

1. 在 Actions 页面查看部署进度
2. 等待所有步骤显示绿色 ✓
3. 通常需要 2-5 分钟

### 步骤 4: 验证修复

部署完成后，访问 `history.tangping.space`：

1. **检查页面是否正常显示**
2. **打开浏览器控制台（F12）**，查看：
   - 应该没有 404 错误
   - 资源路径应该是 `/assets/...` 而不是 `/HistoricalThreads/assets/...`
3. **打开 Network 标签**，刷新页面：
   - 所有资源（JS、CSS、JSON）应该返回 200 状态码
   - 不应该有 404 错误

## 验证资源路径

部署成功后，在浏览器中：

1. 右键点击页面 > **查看网页源代码**
2. 查找 `<script>` 和 `<link>` 标签
3. 确认路径格式：
   - ✅ **正确**：`/assets/index-XXX.js`
   - ❌ **错误**：`/HistoricalThreads/assets/index-XXX.js`

## 如果仍然有问题

### 检查 1: 确认变量已设置

1. 访问：`https://github.com/chengms/HistoricalThreads/settings/secrets/actions`
2. 在 **Variables** 标签页中，确认 `VITE_USE_CUSTOM_DOMAIN` 存在且值为 `true`

### 检查 2: 查看构建日志

1. 访问 Actions 页面
2. 点击最新的 workflow run
3. 查看 **Build** 步骤的日志
4. 确认环境变量已传递：
   ```
   VITE_USE_CUSTOM_DOMAIN=true
   ```

### 检查 3: 清除浏览器缓存

1. 按 `Ctrl+Shift+Delete`（Windows）或 `Cmd+Shift+Delete`（Mac）
2. 选择清除缓存
3. 或者使用无痕模式访问网站

## 重要提示

⚠️ **必须设置环境变量才能修复此问题**

运行时检测只能调整路由和数据加载路径，但无法改变 HTML 中硬编码的资源路径。资源路径必须在构建时正确设置。

## 相关文档

- [自定义域名配置指南](./自定义域名配置指南.md)
- [自定义域名问题排查](./自定义域名问题排查.md)

