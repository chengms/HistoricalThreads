# 数据库设计文档

## 一、ER图概览

```
朝代 (Dynasty)
    │
    ├── 1:N ── 事件 (Event)
    │           │
    │           ├── N:M ── 人物 (Person)
    │           │
    │           └── N:M ── 来源 (Source)
    │
    └── 1:N ── 人物 (Person)
                │
                ├── N:M ── 人物 (Person) [关系]
                │
                └── N:M ── 来源 (Source)
```

## 二、详细表结构

### 2.1 朝代表 (dynasties)

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | SERIAL | PRIMARY KEY | 主键 |
| name | VARCHAR(100) | NOT NULL | 朝代名称 |
| start_year | INTEGER | | 起始年份（公元前为负数） |
| end_year | INTEGER | | 结束年份 |
| description | TEXT | | 朝代简介 |
| created_at | TIMESTAMP | DEFAULT NOW() | 创建时间 |
| updated_at | TIMESTAMP | DEFAULT NOW() | 更新时间 |

**示例数据：**
- 秦朝：-221 到 -207
- 汉朝：-202 到 220
- 唐朝：618 到 907

### 2.2 事件表 (events)

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | SERIAL | PRIMARY KEY | 主键 |
| title | VARCHAR(200) | NOT NULL | 事件标题 |
| description | TEXT | | 事件详细描述 |
| event_date | DATE | | 具体日期（如果已知） |
| event_year | INTEGER | | 年份（用于快速查询） |
| event_month | INTEGER | | 月份（可选） |
| event_day | INTEGER | | 日期（可选） |
| event_type | VARCHAR(50) | | 事件类型：政治/经济/文化/战争/改革/其他 |
| dynasty_id | INTEGER | FOREIGN KEY | 所属朝代 |
| location | VARCHAR(200) | | 发生地点 |
| created_at | TIMESTAMP | DEFAULT NOW() | 创建时间 |
| updated_at | TIMESTAMP | DEFAULT NOW() | 更新时间 |

**事件类型枚举：**
- political: 政治事件
- economic: 经济事件
- cultural: 文化事件
- military: 军事/战争
- reform: 改革
- other: 其他

### 2.3 人物表 (persons)

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | SERIAL | PRIMARY KEY | 主键 |
| name | VARCHAR(100) | NOT NULL | 姓名 |
| name_variants | TEXT[] | | 别名、字、号等 |
| birth_year | INTEGER | | 出生年份 |
| death_year | INTEGER | | 逝世年份 |
| birth_date | DATE | | 出生日期（如果精确） |
| death_date | DATE | | 逝世日期（如果精确） |
| biography | TEXT | | 人物简介 |
| person_type | VARCHAR(50)[] | | 人物类型：政治/经济/文化（可多选） |
| dynasty_id | INTEGER | FOREIGN KEY | 所属朝代 |
| avatar_url | VARCHAR(500) | | 头像图片URL |
| birthplace | VARCHAR(200) | | 出生地 |
| deathplace | VARCHAR(200) | | 逝世地 |
| created_at | TIMESTAMP | DEFAULT NOW() | 创建时间 |
| updated_at | TIMESTAMP | DEFAULT NOW() | 更新时间 |

**人物类型枚举：**
- politician: 政治家
- economist: 经济学家
- writer: 文学家
- artist: 艺术家
- philosopher: 哲学家
- scientist: 科学家
- military: 军事家
- other: 其他

### 2.4 关系表 (relationships)

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | SERIAL | PRIMARY KEY | 主键 |
| from_person_id | INTEGER | FOREIGN KEY | 起始人物ID |
| to_person_id | INTEGER | FOREIGN KEY | 目标人物ID |
| relationship_type | VARCHAR(50) | NOT NULL | 关系类型 |
| description | TEXT | | 关系描述 |
| start_year | INTEGER | | 关系开始年份 |
| end_year | INTEGER | | 关系结束年份 |
| strength | INTEGER | DEFAULT 1 | 关系强度（1-5） |
| created_at | TIMESTAMP | DEFAULT NOW() | 创建时间 |
| updated_at | TIMESTAMP | DEFAULT NOW() | 更新时间 |

**关系类型枚举：**
- teacher_student: 师生关系
- colleague: 同僚关系
- enemy: 敌对关系
- family: 家族关系（父子、兄弟等）
- friend: 朋友关系
- mentor: 导师关系
- influence: 影响关系
- cooperation: 合作关系
- other: 其他关系

### 2.5 事件-人物关联表 (event_persons)

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | SERIAL | PRIMARY KEY | 主键 |
| event_id | INTEGER | FOREIGN KEY | 事件ID |
| person_id | INTEGER | FOREIGN KEY | 人物ID |
| role | VARCHAR(50) | | 角色：主导/参与/影响/反对 |
| description | TEXT | | 在该事件中的具体作用 |
| created_at | TIMESTAMP | DEFAULT NOW() | 创建时间 |

**角色枚举：**
- leader: 主导者
- participant: 参与者
- influencer: 影响者
- opponent: 反对者
- observer: 观察者

### 2.6 来源表 (sources)

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | SERIAL | PRIMARY KEY | 主键 |
| title | VARCHAR(200) | NOT NULL | 来源标题 |
| author | VARCHAR(200) | | 作者/机构 |
| url | VARCHAR(500) | | 来源链接 |
| source_type | VARCHAR(50) | NOT NULL | 来源类型 |
| publisher | VARCHAR(200) | | 出版社/发布机构 |
| publish_date | DATE | | 发布日期 |
| credibility_level | INTEGER | DEFAULT 3 | 可信度评级（1-5） |
| verified | BOOLEAN | DEFAULT FALSE | 是否已验证 |
| verified_by | INTEGER | | 验证人ID |
| verified_at | TIMESTAMP | | 验证时间 |
| created_at | TIMESTAMP | DEFAULT NOW() | 创建时间 |

**来源类型枚举：**
- academic_book: 学术著作
- official_history: 官方史料
- museum: 博物馆资料
- authoritative_website: 权威网站
- research_paper: 研究论文
- archive: 档案资料

### 2.7 事件来源关联表 (event_sources)

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | SERIAL | PRIMARY KEY | 主键 |
| event_id | INTEGER | FOREIGN KEY | 事件ID |
| source_id | INTEGER | FOREIGN KEY | 来源ID |
| page_number | VARCHAR(50) | | 页码或章节 |
| quote | TEXT | | 相关引用 |
| created_at | TIMESTAMP | DEFAULT NOW() | 创建时间 |

### 2.8 人物来源关联表 (person_sources)

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | SERIAL | PRIMARY KEY | 主键 |
| person_id | INTEGER | FOREIGN KEY | 人物ID |
| source_id | INTEGER | FOREIGN KEY | 来源ID |
| page_number | VARCHAR(50) | | 页码或章节 |
| quote | TEXT | | 相关引用 |
| created_at | TIMESTAMP | DEFAULT NOW() | 创建时间 |

### 2.9 建议表 (suggestions)

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | SERIAL | PRIMARY KEY | 主键 |
| suggestion_type | VARCHAR(50) | NOT NULL | 建议类型 |
| target_type | VARCHAR(50) | | 目标类型：event/person/relationship/source |
| target_id | INTEGER | | 目标ID（如果是修正建议） |
| content | JSONB | NOT NULL | 建议内容（JSON格式） |
| submitter_name | VARCHAR(100) | | 提交人姓名 |
| submitter_email | VARCHAR(200) | | 提交人邮箱 |
| submitter_phone | VARCHAR(50) | | 提交人电话（可选） |
| status | VARCHAR(50) | DEFAULT 'pending' | 状态：pending/approved/rejected |
| admin_comment | TEXT | | 管理员审核意见 |
| reviewed_by | INTEGER | | 审核人ID |
| reviewed_at | TIMESTAMP | | 审核时间 |
| created_at | TIMESTAMP | DEFAULT NOW() | 创建时间 |
| updated_at | TIMESTAMP | DEFAULT NOW() | 更新时间 |

**建议类型枚举：**
- add_event: 新增事件
- add_person: 新增人物
- add_relationship: 新增关系
- add_source: 新增来源
- correct_event: 修正事件
- correct_person: 修正人物
- correct_relationship: 修正关系
- other: 其他建议

**建议内容JSON结构示例：**
```json
{
  "title": "事件标题",
  "description": "事件描述",
  "event_year": 1234,
  "event_type": "political",
  "sources": [
    {
      "title": "来源标题",
      "url": "https://..."
    }
  ]
}
```

## 三、索引设计

### 3.1 主键索引（自动创建）
所有表的主键自动创建索引。

### 3.2 外键索引
```sql
CREATE INDEX idx_events_dynasty ON events(dynasty_id);
CREATE INDEX idx_persons_dynasty ON persons(dynasty_id);
CREATE INDEX idx_event_persons_event ON event_persons(event_id);
CREATE INDEX idx_event_persons_person ON event_persons(person_id);
CREATE INDEX idx_relationships_from ON relationships(from_person_id);
CREATE INDEX idx_relationships_to ON relationships(to_person_id);
CREATE INDEX idx_event_sources_event ON event_sources(event_id);
CREATE INDEX idx_event_sources_source ON event_sources(source_id);
CREATE INDEX idx_person_sources_person ON person_sources(person_id);
CREATE INDEX idx_person_sources_source ON person_sources(source_id);
```

### 3.3 时间索引
```sql
CREATE INDEX idx_events_year ON events(event_year);
CREATE INDEX idx_events_date ON events(event_date);
CREATE INDEX idx_persons_birth_year ON persons(birth_year);
CREATE INDEX idx_persons_death_year ON persons(death_year);
```

### 3.4 全文搜索索引
```sql
-- 事件全文搜索
CREATE INDEX idx_events_search ON events 
USING gin(to_tsvector('chinese', title || ' ' || COALESCE(description, '')));

-- 人物全文搜索
CREATE INDEX idx_persons_search ON persons 
USING gin(to_tsvector('chinese', name || ' ' || COALESCE(biography, '')));

-- 朝代全文搜索
CREATE INDEX idx_dynasties_search ON dynasties 
USING gin(to_tsvector('chinese', name || ' ' || COALESCE(description, '')));
```

### 3.5 复合索引
```sql
-- 事件类型和时间复合索引
CREATE INDEX idx_events_type_year ON events(event_type, event_year);

-- 人物类型和朝代复合索引
CREATE INDEX idx_persons_type_dynasty ON persons(person_type, dynasty_id);

-- 建议状态和时间复合索引
CREATE INDEX idx_suggestions_status_created ON suggestions(status, created_at);
```

## 四、数据完整性约束

### 4.1 检查约束
```sql
-- 事件年份合理性检查
ALTER TABLE events ADD CONSTRAINT chk_event_year 
CHECK (event_year >= -3000 AND event_year <= 2100);

-- 人物生卒年检查
ALTER TABLE persons ADD CONSTRAINT chk_person_years 
CHECK (death_year IS NULL OR birth_year IS NULL OR death_year >= birth_year);

-- 可信度评级检查
ALTER TABLE sources ADD CONSTRAINT chk_credibility 
CHECK (credibility_level >= 1 AND credibility_level <= 5);

-- 关系强度检查
ALTER TABLE relationships ADD CONSTRAINT chk_strength 
CHECK (strength >= 1 AND strength <= 5);
```

### 4.2 唯一约束
```sql
-- 防止重复关系
CREATE UNIQUE INDEX idx_relationships_unique 
ON relationships(from_person_id, to_person_id, relationship_type) 
WHERE relationship_type IS NOT NULL;
```

## 五、视图设计

### 5.1 事件详情视图
```sql
CREATE VIEW v_event_details AS
SELECT 
  e.id,
  e.title,
  e.description,
  e.event_date,
  e.event_year,
  e.event_type,
  d.name AS dynasty_name,
  d.start_year AS dynasty_start,
  d.end_year AS dynasty_end,
  COUNT(DISTINCT ep.person_id) AS person_count,
  COUNT(DISTINCT es.source_id) AS source_count
FROM events e
LEFT JOIN dynasties d ON e.dynasty_id = d.id
LEFT JOIN event_persons ep ON e.id = ep.event_id
LEFT JOIN event_sources es ON e.id = es.event_id
GROUP BY e.id, d.id;
```

### 5.2 人物详情视图
```sql
CREATE VIEW v_person_details AS
SELECT 
  p.id,
  p.name,
  p.birth_year,
  p.death_year,
  p.biography,
  p.person_type,
  d.name AS dynasty_name,
  COUNT(DISTINCT ep.event_id) AS event_count,
  COUNT(DISTINCT r1.id) + COUNT(DISTINCT r2.id) AS relationship_count,
  COUNT(DISTINCT ps.source_id) AS source_count
FROM persons p
LEFT JOIN dynasties d ON p.dynasty_id = d.id
LEFT JOIN event_persons ep ON p.id = ep.person_id
LEFT JOIN relationships r1 ON p.id = r1.from_person_id
LEFT JOIN relationships r2 ON p.id = r2.to_person_id
LEFT JOIN person_sources ps ON p.id = ps.person_id
GROUP BY p.id, d.id;
```

## 六、数据迁移策略

### 6.1 初始数据导入
- 准备CSV/JSON格式的初始数据
- 使用批量插入脚本导入
- 验证数据完整性

### 6.2 数据更新
- 使用事务保证数据一致性
- 记录数据变更日志
- 定期备份

## 七、性能优化建议

### 7.1 查询优化
- 使用EXPLAIN分析慢查询
- 避免全表扫描
- 合理使用JOIN

### 7.2 分区策略（大数据量时）
- 按朝代分区事件表
- 按时间范围分区

### 7.3 缓存策略
- 热点数据缓存（Redis）
- 查询结果缓存
- 静态数据缓存

