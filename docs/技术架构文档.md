# 中国历史时间线网站 - 技术架构文档

## 一、技术栈选择

### 1.1 前端技术栈
```
- 框架：React 18 + TypeScript
- 构建工具：Vite
- UI组件库：Ant Design 5.x
- 状态管理：Zustand / Redux Toolkit
- 路由：React Router v6
- 时间线可视化：vis-timeline
- 关系图谱：vis-network / D3.js
- 图表库：ECharts（辅助图表）
- 样式方案：Tailwind CSS + CSS Modules
- 动画库：Framer Motion
- HTTP客户端：Axios
```

### 1.2 后端技术栈
```
- 运行时：Node.js 18+
- 框架：Express.js / Fastify
- 数据库：PostgreSQL 14+
- ORM：Prisma / TypeORM
- 全文搜索：PostgreSQL全文搜索 + pg_trgm
- 认证：JWT
- 文件上传：Multer
- API文档：Swagger/OpenAPI
```

### 1.3 开发工具
```
- 代码规范：ESLint + Prettier
- 类型检查：TypeScript strict mode
- 测试：Vitest + React Testing Library
- Git工作流：Conventional Commits
```

## 二、系统架构

### 2.1 整体架构
```
┌─────────────────────────────────────────┐
│           前端应用 (React)               │
│  ┌──────────┐  ┌──────────┐  ┌────────┐│
│  │ 时间线   │  │ 关系图谱 │  │ 搜索   ││
│  │ 组件     │  │ 组件     │  │ 组件   ││
│  └──────────┘  └──────────┘  └────────┘│
└─────────────────────────────────────────┘
                    │
                    │ HTTP/REST API
                    │
┌─────────────────────────────────────────┐
│        后端服务 (Node.js/Express)       │
│  ┌──────────┐  ┌──────────┐  ┌────────┐│
│  │ 事件API  │  │ 人物API  │  │ 建议API││
│  └──────────┘  └──────────┘  └────────┘│
└─────────────────────────────────────────┘
                    │
                    │ SQL
                    │
┌─────────────────────────────────────────┐
│        数据库 (PostgreSQL)              │
│  ┌──────────┐  ┌──────────┐  ┌────────┐│
│  │ 事件表   │  │ 人物表   │  │ 关系表 ││
│  └──────────┘  └──────────┘  └────────┘│
└─────────────────────────────────────────┘
```

### 2.2 目录结构
```
historical-threads/
├── frontend/                 # 前端应用
│   ├── src/
│   │   ├── components/      # 组件
│   │   │   ├── Timeline/    # 时间线组件
│   │   │   ├── Network/     # 关系图谱组件
│   │   │   ├── EventCard/   # 事件卡片
│   │   │   ├── PersonCard/  # 人物卡片
│   │   │   └── Suggestion/  # 建议组件
│   │   ├── pages/           # 页面
│   │   │   ├── Timeline/    # 时间线页面
│   │   │   ├── Network/     # 关系图谱页面
│   │   │   ├── Detail/      # 详情页面
│   │   │   └── Admin/        # 管理后台
│   │   ├── hooks/           # 自定义Hooks
│   │   ├── services/        # API服务
│   │   ├── store/           # 状态管理
│   │   ├── types/           # TypeScript类型
│   │   ├── utils/           # 工具函数
│   │   └── styles/          # 样式文件
│   ├── public/
│   └── package.json
│
├── backend/                  # 后端服务
│   ├── src/
│   │   ├── controllers/     # 控制器
│   │   ├── services/        # 业务逻辑
│   │   ├── models/          # 数据模型
│   │   ├── routes/          # 路由
│   │   ├── middleware/      # 中间件
│   │   ├── utils/           # 工具函数
│   │   └── types/           # TypeScript类型
│   ├── prisma/              # Prisma配置
│   └── package.json
│
├── docs/                     # 文档
├── .gitignore
└── README.md
```

## 三、数据库设计

### 3.1 核心表结构

#### 朝代表 (dynasties)
```sql
CREATE TABLE dynasties (
  id SERIAL PRIMARY KEY,
  name VARCHAR(100) NOT NULL,
  start_year INTEGER,
  end_year INTEGER,
  description TEXT,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

#### 事件表 (events)
```sql
CREATE TABLE events (
  id SERIAL PRIMARY KEY,
  title VARCHAR(200) NOT NULL,
  description TEXT,
  event_date DATE,
  event_year INTEGER,
  event_type VARCHAR(50), -- 政治/经济/文化/战争等
  dynasty_id INTEGER REFERENCES dynasties(id),
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

#### 人物表 (persons)
```sql
CREATE TABLE persons (
  id SERIAL PRIMARY KEY,
  name VARCHAR(100) NOT NULL,
  birth_year INTEGER,
  death_year INTEGER,
  birth_date DATE,
  death_date DATE,
  biography TEXT,
  person_type VARCHAR(50), -- 政治/经济/文化
  dynasty_id INTEGER REFERENCES dynasties(id),
  avatar_url VARCHAR(500),
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

#### 关系表 (relationships)
```sql
CREATE TABLE relationships (
  id SERIAL PRIMARY KEY,
  from_person_id INTEGER REFERENCES persons(id),
  to_person_id INTEGER REFERENCES persons(id),
  relationship_type VARCHAR(50), -- 师生/同僚/敌对/家族/朋友
  description TEXT,
  start_year INTEGER,
  end_year INTEGER,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

#### 事件-人物关联表 (event_persons)
```sql
CREATE TABLE event_persons (
  id SERIAL PRIMARY KEY,
  event_id INTEGER REFERENCES events(id),
  person_id INTEGER REFERENCES persons(id),
  role VARCHAR(50), -- 主导/参与/影响
  created_at TIMESTAMP DEFAULT NOW()
);
```

#### 来源表 (sources)
```sql
CREATE TABLE sources (
  id SERIAL PRIMARY KEY,
  title VARCHAR(200) NOT NULL,
  url VARCHAR(500),
  source_type VARCHAR(50), -- 学术著作/官方史料/博物馆/网站
  credibility_level INTEGER, -- 1-5可信度评级
  verified BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP DEFAULT NOW()
);
```

#### 事件来源关联表 (event_sources)
```sql
CREATE TABLE event_sources (
  id SERIAL PRIMARY KEY,
  event_id INTEGER REFERENCES events(id),
  source_id INTEGER REFERENCES sources(id),
  created_at TIMESTAMP DEFAULT NOW()
);
```

#### 人物来源关联表 (person_sources)
```sql
CREATE TABLE person_sources (
  id SERIAL PRIMARY KEY,
  person_id INTEGER REFERENCES persons(id),
  source_id INTEGER REFERENCES sources(id),
  created_at TIMESTAMP DEFAULT NOW()
);
```

#### 建议表 (suggestions)
```sql
CREATE TABLE suggestions (
  id SERIAL PRIMARY KEY,
  suggestion_type VARCHAR(50), -- 新增/修正/来源补充
  target_type VARCHAR(50), -- event/person/relationship
  target_id INTEGER,
  content JSONB, -- 建议的具体内容
  submitter_name VARCHAR(100),
  submitter_email VARCHAR(200),
  status VARCHAR(50) DEFAULT 'pending', -- pending/approved/rejected
  admin_comment TEXT,
  reviewed_by INTEGER,
  reviewed_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT NOW()
);
```

### 3.2 索引设计
```sql
-- 事件表索引
CREATE INDEX idx_events_date ON events(event_date);
CREATE INDEX idx_events_year ON events(event_year);
CREATE INDEX idx_events_type ON events(event_type);
CREATE INDEX idx_events_dynasty ON events(dynasty_id);

-- 人物表索引
CREATE INDEX idx_persons_birth_year ON persons(birth_year);
CREATE INDEX idx_persons_type ON persons(person_type);
CREATE INDEX idx_persons_dynasty ON persons(dynasty_id);

-- 全文搜索索引
CREATE INDEX idx_events_title_search ON events USING gin(to_tsvector('chinese', title || ' ' || COALESCE(description, '')));
CREATE INDEX idx_persons_name_search ON persons USING gin(to_tsvector('chinese', name || ' ' || COALESCE(biography, '')));
```

## 四、API设计

### 4.1 RESTful API规范

#### 事件相关API
```
GET    /api/events              # 获取事件列表（支持分页、筛选）
GET    /api/events/:id          # 获取事件详情
POST   /api/events              # 创建事件（管理员）
PUT    /api/events/:id          # 更新事件（管理员）
DELETE /api/events/:id          # 删除事件（管理员）
GET    /api/events/timeline     # 获取时间线数据
```

#### 人物相关API
```
GET    /api/persons             # 获取人物列表
GET    /api/persons/:id         # 获取人物详情
POST   /api/persons             # 创建人物（管理员）
PUT    /api/persons/:id         # 更新人物（管理员）
DELETE /api/persons/:id         # 删除人物（管理员）
GET    /api/persons/:id/events  # 获取人物相关事件
GET    /api/persons/:id/relationships # 获取人物关系
```

#### 关系相关API
```
GET    /api/relationships       # 获取关系列表
GET    /api/relationships/network # 获取关系网络数据
POST   /api/relationships       # 创建关系（管理员）
PUT    /api/relationships/:id  # 更新关系（管理员）
DELETE /api/relationships/:id  # 删除关系（管理员）
```

#### 建议相关API
```
GET    /api/suggestions         # 获取建议列表（管理员）
POST   /api/suggestions         # 提交建议
PUT    /api/suggestions/:id     # 审核建议（管理员）
GET    /api/suggestions/:id     # 获取建议详情
```

#### 搜索API
```
GET    /api/search              # 全文搜索
GET    /api/search/advanced     # 高级搜索
```

### 4.2 响应格式
```typescript
// 成功响应
{
  success: true,
  data: {...},
  message?: string
}

// 错误响应
{
  success: false,
  error: {
    code: string,
    message: string,
    details?: any
  }
}

// 分页响应
{
  success: true,
  data: [...],
  pagination: {
    page: number,
    pageSize: number,
    total: number,
    totalPages: number
  }
}
```

## 五、前端组件设计

### 5.1 时间线组件 (Timeline)
- 使用 vis-timeline 库
- 支持时间范围选择
- 事件卡片悬浮显示详情
- 支持筛选和搜索
- 响应式设计

### 5.2 关系图谱组件 (Network)
- 使用 vis-network 或 D3.js
- 力导向布局
- 节点点击查看详情
- 关系线显示关系类型
- 支持筛选特定节点和关系

### 5.3 事件/人物卡片组件
- 响应式卡片设计
- 显示关键信息
- 来源链接展示
- 相关事件/人物推荐

## 六、性能优化策略

### 6.1 前端优化
- 虚拟滚动（处理大量数据）
- 组件懒加载
- 图片懒加载和CDN
- 代码分割和按需加载
- 缓存策略（Service Worker）

### 6.2 后端优化
- 数据库查询优化（索引、分页）
- API响应缓存（Redis）
- 数据预加载
- 全文搜索优化

### 6.3 数据优化
- 时间线数据分页加载
- 关系图谱按需加载
- 图片压缩和WebP格式

## 七、安全考虑

### 7.1 数据安全
- SQL注入防护（参数化查询）
- XSS防护（输入验证和转义）
- CSRF防护（Token验证）

### 7.2 访问控制
- 管理员认证（JWT）
- 建议提交限流
- API访问频率限制

## 八、部署方案

### 8.1 开发环境
- 前端：Vite dev server
- 后端：Node.js + nodemon
- 数据库：本地PostgreSQL

### 8.2 生产环境
- 前端：Vercel / Netlify（静态部署）
- 后端：Docker容器 + 云服务器
- 数据库：云数据库（RDS）
- CDN：静态资源加速

