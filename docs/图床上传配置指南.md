# 图床上传功能配置指南

## 概述

本项目的图片上传功能使用独立的图床服务，通过环境变量配置 API 地址，确保安全性。

## 环境变量配置

### 1. 本地开发环境

在 `frontend/.env` 文件中添加：

```env
VITE_IMAGE_UPLOAD_API=https://cms-images.netlify.app/.netlify/functions/upload-image
```

### 2. GitHub Actions 部署

在 GitHub 仓库设置中添加 Repository Variable：

1. 进入仓库：`Settings` > `Secrets and variables` > `Actions`
2. 点击 `Variables` 标签页（不是 Secrets）
3. 点击 `New repository variable`
4. 添加变量：
   - **Name**: `VITE_IMAGE_UPLOAD_API`
   - **Value**: `https://cms-images.netlify.app/.netlify/functions/upload-image`（或您的图床 API 地址）

## API 格式要求

图床 API 需要支持以下格式：

### 请求格式

```json
{
  "filename": "comments/1234567890-abc123.jpg",
  "content": "base64编码的图片内容"
}
```

### 响应格式

成功时返回：
```json
{
  "url": "https://cdn.jsdelivr.net/gh/username/repo@main/images/comments/1234567890-abc123.jpg"
}
```

失败时返回：
```json
{
  "error": "错误信息"
}
```

## 功能说明

### 1. 建议表单图片上传

- 位置：提交建议页面
- 限制：最多 5 张图片，单张不超过 5MB
- 格式：JPG、PNG
- 上传后自动插入到建议内容中

### 2. 评论图片上传

- 位置：详情页评论区域
- 限制：最多 5 张图片，单张不超过 5MB
- 格式：JPG、PNG
- 上传后自动插入到评论输入框（Markdown 格式）
- 显示上传进度条

### 3. 图片显示

- 评论中的图片会自动显示
- 支持点击放大查看
- 响应式布局，适配不同屏幕

## 安全注意事项

⚠️ **重要**：图床 API 地址已配置为环境变量，不会暴露在代码中。

- ✅ 环境变量仅在构建时使用
- ✅ 不会出现在客户端代码中
- ✅ 可以通过 GitHub Variables 安全管理

## 故障排查

### 问题 1: 图片上传失败

**可能原因：**
- 环境变量未配置
- API 地址不正确
- 图床服务不可用

**解决方法：**
1. 检查 `.env` 文件或 GitHub Variables 中的 `VITE_IMAGE_UPLOAD_API`
2. 验证 API 地址是否正确
3. 检查图床服务是否正常运行

### 问题 2: 图片不显示

**可能原因：**
- 图片 URL 格式不正确
- CDN 服务不可用
- 图片路径错误

**解决方法：**
1. 检查返回的图片 URL 是否有效
2. 在浏览器中直接访问图片 URL 测试
3. 检查 CDN 服务状态

### 问题 3: Twikoo 上传按钮仍然显示

**解决方法：**
1. 清除浏览器缓存
2. 检查 CSS 文件是否正确加载
3. 查看浏览器控制台是否有错误

## 测试

### 本地测试

1. 在 `frontend/.env` 中配置 `VITE_IMAGE_UPLOAD_API`
2. 启动开发服务器：`npm run dev`
3. 访问详情页，测试图片上传功能
4. 检查图片是否正确显示在评论中

### 生产环境测试

1. 确保 GitHub Variables 中已配置 `VITE_IMAGE_UPLOAD_API`
2. 触发 GitHub Actions 部署
3. 在生产环境中测试图片上传和显示

## 相关文件

- `frontend/src/components/TwikooComment/index.tsx` - 评论组件和图片上传
- `frontend/src/pages/Suggestion/index.tsx` - 建议表单图片上传
- `frontend/src/styles/twikoo-comment.css` - 评论样式（包括图片显示）
- `.github/workflows/deploy.yml` - GitHub Actions 部署配置

