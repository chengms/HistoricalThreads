# 自定义域名配置指南

## 概述

当使用自定义域名（如 `history.tangping.space`）时，需要修改配置以确保网站正常显示。

## 问题原因

使用自定义域名时，网站部署在根路径（`/`），而不是 GitHub Pages 的子路径（`/HistoricalThreads/`）。因此需要调整 base path 配置。

## 配置方法

### 方法一：使用环境变量（推荐）

在 `frontend` 目录下创建 `.env.production` 文件：

```env
VITE_USE_CUSTOM_DOMAIN=true
```

这样在生产环境构建时，会自动使用根路径 `/` 而不是 `/HistoricalThreads/`。

### 方法二：自动检测（已实现）

代码已经实现了自动检测功能：
- 如果当前域名不包含 `github.io`，会自动使用根路径
- 如果域名包含 `github.io`，会使用 `/HistoricalThreads/` 子路径

### 方法三：手动修改配置

如果需要手动控制，可以修改以下文件：

1. **frontend/vite.config.ts**
   ```typescript
   base: process.env.VITE_USE_CUSTOM_DOMAIN === 'true' 
     ? '/' 
     : (process.env.NODE_ENV === 'production' ? '/HistoricalThreads/' : '/')
   ```

2. **frontend/src/App.tsx**
   ```typescript
   const isCustomDomain = import.meta.env.VITE_USE_CUSTOM_DOMAIN === 'true' || 
                          (typeof window !== 'undefined' && !window.location.hostname.includes('github.io'))
   const basename = isCustomDomain ? '' : (import.meta.env.PROD ? '/HistoricalThreads' : '')
   ```

3. **frontend/src/services/dataLoader.ts**
   ```typescript
   const isCustomDomain = import.meta.env.VITE_USE_CUSTOM_DOMAIN === 'true' || 
                          (typeof window !== 'undefined' && !window.location.hostname.includes('github.io'))
   if (isCustomDomain || !import.meta.env.PROD) {
     return ''
   }
   return '/HistoricalThreads'
   ```

## 部署步骤

1. **创建环境变量文件**
   ```bash
   cd frontend
   echo "VITE_USE_CUSTOM_DOMAIN=true" > .env.production
   ```

2. **重新构建**
   ```bash
   npm run build
   ```

3. **提交并推送**
   ```bash
   git add frontend/.env.production
   git commit -m "Configure for custom domain"
   git push origin main
   ```

4. **等待 GitHub Actions 部署完成**

## 验证

部署完成后，访问自定义域名，检查：
- ✅ 页面正常显示
- ✅ CSS 和 JS 文件正常加载
- ✅ 路由正常工作
- ✅ 数据文件正常加载

## 注意事项

1. **不要提交 `.env.production` 到 Git**（如果包含敏感信息）
   - 如果只是 `VITE_USE_CUSTOM_DOMAIN=true`，可以提交
   - 如果包含 Token 等敏感信息，应该添加到 `.gitignore`

2. **GitHub Actions 构建**
   - 如果使用 GitHub Actions 自动部署，需要在 Actions Secrets 中设置环境变量
   - 或者在 workflow 文件中设置环境变量

3. **DNS 配置**
   - 确保 DNS 正确指向 GitHub Pages
   - 在 GitHub 仓库设置中配置自定义域名

## 故障排查

### 问题：404 错误

**原因**：base path 配置不正确

**解决**：
1. 检查 `.env.production` 文件是否存在且包含 `VITE_USE_CUSTOM_DOMAIN=true`
2. 重新构建项目
3. 清除浏览器缓存

### 问题：CSS/JS 文件加载失败

**原因**：资源路径不正确

**解决**：
1. 检查浏览器控制台的错误信息
2. 确认资源路径是否以 `/` 开头（自定义域名）或 `/HistoricalThreads/` 开头（GitHub Pages）
3. 检查 `vite.config.ts` 中的 `base` 配置

### 问题：路由不工作

**原因**：`basename` 配置不正确

**解决**：
1. 检查 `App.tsx` 中的 `basename` 是否正确
2. 确认自定义域名模式下 `basename` 为空字符串

## 相关文件

- `frontend/vite.config.ts` - Vite 构建配置
- `frontend/src/App.tsx` - React Router 配置
- `frontend/src/services/dataLoader.ts` - 数据加载路径配置
- `.github/workflows/deploy.yml` - GitHub Actions 部署配置

