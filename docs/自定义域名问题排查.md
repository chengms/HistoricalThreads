# 自定义域名问题排查指南

## 问题现象

使用自定义域名（如 `history.tangping.space`）时，网站显示空白页面。

## 可能的原因

1. **构建时 base path 配置不正确**
   - 如果构建时没有设置 `VITE_USE_CUSTOM_DOMAIN=true`，构建出来的资源路径会是 `/HistoricalThreads/`
   - 但运行时检测到自定义域名，会尝试用根路径 `/` 加载资源
   - 导致资源路径不匹配，无法加载

2. **运行时检测逻辑问题**
   - 域名检测可能不准确
   - 需要检查控制台日志

## 解决方案

### 方案一：在 GitHub Actions 中设置环境变量（推荐）

1. 进入 GitHub 仓库设置：
   - 访问 `https://github.com/chengms/HistoricalThreads/settings`
   - 点击左侧菜单的 **Secrets and variables** > **Actions**
   - 点击 **Variables** 标签页
   - 点击 **New repository variable**

2. 添加变量：
   - **Name**: `VITE_USE_CUSTOM_DOMAIN`
   - **Value**: `true`
   - 点击 **Add variable**

3. 重新触发部署：
   - 可以推送一个空提交，或者
   - 在 Actions 页面手动触发 workflow

### 方案二：创建 `.env.production` 文件（本地构建）

如果需要在本地构建后手动部署：

1. 在 `frontend` 目录下创建 `.env.production` 文件：
   ```env
   VITE_USE_CUSTOM_DOMAIN=true
   ```

2. 构建项目：
   ```bash
   cd frontend
   npm run build
   ```

3. 手动部署 `dist` 目录到 GitHub Pages

### 方案三：检查运行时检测

即使构建时使用了错误的 base path，运行时也会自动检测域名并调整路径。但资源文件路径是在构建时确定的，所以仍然需要正确设置构建时的环境变量。

## 调试步骤

1. **打开浏览器控制台**，查看是否有错误信息

2. **检查调试日志**：
   - 应该能看到 `[App] 域名检测:` 和 `[dataLoader] Base path:` 的日志
   - 确认 `isCustomDomain` 是否为 `true`
   - 确认 `basename` 和 `basePath` 是否正确

3. **检查网络请求**：
   - 打开开发者工具的 **Network** 标签
   - 刷新页面
   - 查看哪些资源加载失败（404 错误）
   - 检查失败的资源路径是否正确

4. **检查构建产物**：
   - 查看 `dist/index.html` 中的资源路径
   - 如果路径是 `/HistoricalThreads/assets/...`，说明构建时没有设置环境变量
   - 如果路径是 `/assets/...`，说明构建配置正确

## 验证

部署完成后，访问自定义域名，检查：

- ✅ 页面正常显示
- ✅ 控制台没有 404 错误
- ✅ CSS 和 JS 文件正常加载（Network 标签中状态码为 200）
- ✅ 数据文件（JSON）正常加载
- ✅ 路由正常工作（点击导航链接不会出现 404）

## 常见错误

### 错误 1: 资源路径 404

**现象**: 控制台显示 `GET https://history.tangping.space/HistoricalThreads/assets/... 404`

**原因**: 构建时使用了 `/HistoricalThreads/` base path，但自定义域名应该使用 `/`

**解决**: 在 GitHub Actions 中设置 `VITE_USE_CUSTOM_DOMAIN=true`

### 错误 2: 路由 404

**现象**: 点击链接后页面显示 404

**原因**: `basename` 配置不正确

**解决**: 检查 `App.tsx` 中的 `basename` 是否正确设置为空字符串

### 错误 3: 数据文件加载失败

**现象**: 时间线页面空白，控制台显示 JSON 文件加载失败

**原因**: `dataLoader.ts` 中的 `getBasePath()` 返回了错误的路径

**解决**: 检查 `dataLoader.ts` 中的域名检测逻辑

## 相关文件

- `.github/workflows/deploy.yml` - GitHub Actions 工作流配置
- `frontend/vite.config.ts` - Vite 构建配置
- `frontend/src/App.tsx` - React Router 配置
- `frontend/src/services/dataLoader.ts` - 数据加载路径配置

