/**
 * 细化专题分类脚本
 * 将现有的分类细化为更具体的子分类
 * 
 * 分类细化规则：
 * - 制度：政治制度、选官制度、法律制度、军事制度、赋税制度
 * - 经济：农业、商业、手工业、货币、经济政策
 * - 思想：儒家思想、道家思想、法家思想、佛教、理学、新文化
 * - 对外关系：朝贡、贸易、战争、文化交流、外交政策
 */

const fs = require('fs')
const path = require('path')

// 分类映射规则
const categoryMapping = {
  // 制度类细化
  '中国古代史/政治制度': {
    '分封制': '中国古代史/制度/政治制度',
    '宗法制': '中国古代史/制度/政治制度',
    '郡县制': '中国古代史/制度/政治制度',
    '中央集权': '中国古代史/制度/政治制度',
    '三省六部': '中国古代史/制度/政治制度',
    '科举': '中国古代史/制度/选官制度',
    '选官': '中国古代史/制度/选官制度',
    '察举': '中国古代史/制度/选官制度',
    '九品中正': '中国古代史/制度/选官制度',
    '法律': '中国古代史/制度/法律制度',
    '刑法': '中国古代史/制度/法律制度',
    '赋税': '中国古代史/制度/赋税制度',
    '税制': '中国古代史/制度/赋税制度',
    '两税法': '中国古代史/制度/赋税制度',
    '均田制': '中国古代史/制度/赋税制度',
    '府兵': '中国古代史/制度/军事制度',
    '募兵': '中国古代史/制度/军事制度',
    '军制': '中国古代史/制度/军事制度',
  },
  // 经济类细化
  '中国古代史/经济': {
    '农业': '中国古代史/经济/农业',
    '土地': '中国古代史/经济/农业',
    '商业': '中国古代史/经济/商业',
    '贸易': '中国古代史/经济/商业',
    '市场': '中国古代史/经济/商业',
    '手工业': '中国古代史/经济/手工业',
    '货币': '中国古代史/经济/货币',
    '钱币': '中国古代史/经济/货币',
  },
  '中国古代史/经济与社会': {
    '农业': '中国古代史/经济/农业',
    '商业': '中国古代史/经济/商业',
    '手工业': '中国古代史/经济/手工业',
  },
  '中国古代史/政治与经济': {
    '经济': '中国古代史/经济/经济政策',
    '农业': '中国古代史/经济/农业',
    '商业': '中国古代史/经济/商业',
  },
  // 思想类细化
  '中国古代史/思想文化': {
    '儒家': '中国古代史/思想/儒家思想',
    '儒学': '中国古代史/思想/儒家思想',
    '孔子': '中国古代史/思想/儒家思想',
    '孟子': '中国古代史/思想/儒家思想',
    '道家': '中国古代史/思想/道家思想',
    '老子': '中国古代史/思想/道家思想',
    '庄子': '中国古代史/思想/道家思想',
    '法家': '中国古代史/思想/法家思想',
    '商鞅': '中国古代史/思想/法家思想',
    '韩非': '中国古代史/思想/法家思想',
    '佛教': '中国古代史/思想/佛教',
    '佛': '中国古代史/思想/佛教',
    '理学': '中国古代史/思想/理学',
    '朱熹': '中国古代史/思想/理学',
    '程朱': '中国古代史/思想/理学',
    '心学': '中国古代史/思想/理学',
    '王阳明': '中国古代史/思想/理学',
  },
  // 对外关系类细化
  '中国古代史/对外关系': {
    '朝贡': '中国古代史/对外关系/朝贡',
    '贸易': '中国古代史/对外关系/贸易',
    '丝绸之路': '中国古代史/对外关系/贸易',
    '战争': '中国古代史/对外关系/战争',
    '军事': '中国古代史/对外关系/战争',
    '文化交流': '中国古代史/对外关系/文化交流',
    '宗教': '中国古代史/对外关系/文化交流',
    '外交': '中国古代史/对外关系/外交政策',
  },
  '中国古代史/政治与对外关系': {
    '对外': '中国古代史/对外关系/外交政策',
    '外交': '中国古代史/对外关系/外交政策',
  },
  // 近现代思想
  '中国近现代史/思想文化': {
    '新文化': '中国近现代史/思想/新文化运动',
    '五四': '中国近现代史/思想/新文化运动',
    '民主': '中国近现代史/思想/新文化运动',
    '科学': '中国近现代史/思想/新文化运动',
  },
  // 近现代经济
  '中国近现代史/经济与社会': {
    '经济': '中国近现代史/经济/经济政策',
    '工业': '中国近现代史/经济/工业',
    '商业': '中国近现代史/经济/商业',
  },
  '中国现代史/经济与社会': {
    '经济': '中国现代史/经济/经济政策',
    '工业': '中国现代史/经济/工业',
  },
  '中国当代史/经济与制度': {
    '经济': '中国当代史/经济/经济政策',
    '制度': '中国当代史/制度/经济制度',
  },
  '中国当代史/经济与开放': {
    '经济': '中国当代史/经济/经济政策',
    '开放': '中国当代史/对外关系/对外开放',
  },
}

// 根据标题和要点推断更细的分类
function refineCategory(knowledgePoint) {
  const { category, title, keyPoints = [], summary = '' } = knowledgePoint
  
  if (!category) return category
  
  // 获取该分类的映射规则
  const mapping = categoryMapping[category]
  if (!mapping) return category
  
  // 合并所有文本用于匹配
  const text = [title, summary, ...keyPoints].join(' ')
  
  // 查找匹配的关键词
  for (const [keyword, newCategory] of Object.entries(mapping)) {
    if (text.includes(keyword)) {
      return newCategory
    }
  }
  
  // 如果没有匹配，返回原分类
  return category
}

function main() {
  const inputPath = path.join(__dirname, '../../frontend/public/data/knowledge_points.json')
  const outputPath = inputPath
  
  console.log('读取知识点数据...')
  const data = JSON.parse(fs.readFileSync(inputPath, 'utf-8'))
  
  console.log(`共 ${data.length} 个知识点`)
  
  let updatedCount = 0
  const updated = data.map(kp => {
    const oldCategory = kp.category
    const newCategory = refineCategory(kp)
    
    if (oldCategory !== newCategory) {
      updatedCount++
      console.log(`更新: "${oldCategory}" -> "${newCategory}" (${kp.title})`)
      return { ...kp, category: newCategory }
    }
    
    return kp
  })
  
  console.log(`\n共更新 ${updatedCount} 个知识点的分类`)
  
  // 备份原文件
  const backupPath = inputPath + '.backup'
  fs.copyFileSync(inputPath, backupPath)
  console.log(`已备份原文件到: ${backupPath}`)
  
  // 写入更新后的数据
  fs.writeFileSync(outputPath, JSON.stringify(updated, null, 2), 'utf-8')
  console.log(`已保存更新后的数据到: ${outputPath}`)
}

if (require.main === module) {
  main()
}

module.exports = { refineCategory }

